#!/bin/bash

#=============================================================================
# –°–ö–†–ò–ü–¢ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–õ–û–Ø FLUTTER WEB –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# –ü—Ä–æ–µ–∫—Ç: GoGoMarket
# –ê–≤—Ç–æ—Ä: –°–æ–∑–¥–∞–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ Cursor AI
#=============================================================================

set -e  # –ü—Ä–µ—Ä–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

#-----------------------------------------------------------------------------
# –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
#-----------------------------------------------------------------------------

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
if [ -f "${SCRIPT_DIR}/deploy_config.sh" ]; then
    source "${SCRIPT_DIR}/deploy_config.sh" silent
else
    echo "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ deploy_config.sh –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: ${SCRIPT_DIR}"
    exit 1
fi

#-----------------------------------------------------------------------------
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
#-----------------------------------------------------------------------------

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p "${LOG_DIR}"
mkdir -p "${BACKUP_DIR}"

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE_PATH="${LOG_DIR}/${LOG_FILE}_${TIMESTAMP}.log"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    local level=$1
    shift
    local message="$@"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    echo "[${timestamp}] [${level}] ${message}" | tee -a "${LOG_FILE_PATH}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ü–≤–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
print_color() {
    local color=$1
    shift
    local message="$@"
    echo -e "${color}${message}${COLOR_RESET}" | tee -a "${LOG_FILE_PATH}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å–µ–∫—Ü–∏–∏
print_section() {
    local title="$1"
    echo "" | tee -a "${LOG_FILE_PATH}"
    print_color "${COLOR_CYAN}" "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    print_color "${COLOR_CYAN}" "  ${title}"
    print_color "${COLOR_CYAN}" "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
handle_error() {
    local line_num=$1
    print_color "${COLOR_RED}" "\n‚ùå –û–®–ò–ë–ö–ê –Ω–∞ —Å—Ç—Ä–æ–∫–µ ${line_num}"
    print_color "${COLOR_RED}" "   –î–µ–ø–ª–æ–π –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏"
    log "ERROR" "–î–µ–ø–ª–æ–π –ø—Ä–µ—Ä–≤–∞–Ω –Ω–∞ —Å—Ç—Ä–æ–∫–µ ${line_num}"
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
    if [ -n "${NOTIFICATION_EMAIL}" ]; then
        send_email_notification "FAILED" "–î–µ–ø–ª–æ–π –ø—Ä–µ—Ä–≤–∞–Ω –Ω–∞ —Å—Ç—Ä–æ–∫–µ ${line_num}"
    fi
    
    exit 1
}

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
trap 'handle_error ${LINENO}' ERR

#-----------------------------------------------------------------------------
# –ù–ê–ß–ê–õ–û –î–ï–ü–õ–û–Ø
#-----------------------------------------------------------------------------

print_section "üöÄ –ù–ê–ß–ê–õ–û –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –î–ï–ü–õ–û–Ø"
log "INFO" "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–ø–ª–æ—è"
log "INFO" "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –°–µ—Ä–≤–µ—Ä=${SERVER_IP}, –ü—Ä–æ–µ–∫—Ç=${PROJECT_DIR}, –í–µ—Ç–∫–∞=${DEPLOY_BRANCH}"

print_color "${COLOR_YELLOW}" "üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')"
print_color "${COLOR_YELLOW}" "üñ•Ô∏è  –°–µ—Ä–≤–µ—Ä: ${SERVER_USER}@${SERVER_IP}"
print_color "${COLOR_YELLOW}" "üìÇ –ü—Ä–æ–µ–∫—Ç: ${PROJECT_DIR}"
print_color "${COLOR_YELLOW}" "üåø –í–µ—Ç–∫–∞: ${DEPLOY_BRANCH}"

#-----------------------------------------------------------------------------
# –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
#-----------------------------------------------------------------------------

print_section "üîç –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø"

log "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Flutter
if ! command -v flutter &> /dev/null; then
    print_color "${COLOR_RED}" "‚ùå Flutter –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    log "ERROR" "Flutter –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ"
    exit 1
fi
print_color "${COLOR_GREEN}" "‚úì Flutter —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(flutter --version | head -n 1)"
log "INFO" "Flutter version: $(flutter --version | head -n 1)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Git
if ! command -v git &> /dev/null; then
    print_color "${COLOR_RED}" "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    log "ERROR" "Git –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ"
    exit 1
fi
print_color "${COLOR_GREEN}" "‚úì Git —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(git --version)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è SSH
if ! command -v ssh &> /dev/null; then
    print_color "${COLOR_RED}" "‚ùå SSH –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    log "ERROR" "SSH –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ"
    exit 1
fi
print_color "${COLOR_GREEN}" "‚úì SSH –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "${PROJECT_DIR}" ]; then
    print_color "${COLOR_RED}" "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${PROJECT_DIR}"
    log "ERROR" "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    exit 1
fi
print_color "${COLOR_GREEN}" "‚úì –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞"

#-----------------------------------------------------------------------------
# –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê SSH –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø
#-----------------------------------------------------------------------------

print_section "üîê –®–ê–ì 2: –ü–†–û–í–ï–†–ö–ê SSH –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø"

log "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É"

# –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É SSH
if [ -n "${SSH_KEY_PATH}" ]; then
    SSH_CMD="ssh -i ${SSH_KEY_PATH} -p ${SSH_PORT} ${SERVER_USER}@${SERVER_IP}"
    SCP_CMD="scp -i ${SSH_KEY_PATH} -P ${SSH_PORT}"
elif [ -n "${SSH_HOST_ALIAS}" ]; then
    SSH_CMD="ssh ${SSH_HOST_ALIAS}"
    SCP_CMD="scp"
else
    SSH_CMD="ssh -p ${SSH_PORT} ${SERVER_USER}@${SERVER_IP}"
    SCP_CMD="scp -P ${SSH_PORT}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
if ${SSH_CMD} "echo 'SSH connection test'" &> /dev/null; then
    print_color "${COLOR_GREEN}" "‚úì SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ"
    log "INFO" "SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    print_color "${COLOR_RED}" "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É!"
    print_color "${COLOR_YELLOW}" "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
    print_color "${COLOR_YELLOW}" "   - SSH –∫–ª—é—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    print_color "${COLOR_YELLOW}" "   - IP –∞–¥—Ä–µ—Å –∏ –ø–æ—Ä—Ç —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
    print_color "${COLOR_YELLOW}" "   - –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (ping ${SERVER_IP})"
    print_color "${COLOR_YELLOW}" "\n   –°–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: SSH_SETUP.md"
    log "ERROR" "SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
    exit 1
fi

#-----------------------------------------------------------------------------
# –®–ê–ì 3: –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –ö–û–î–ï
#-----------------------------------------------------------------------------

print_section "üîÑ –®–ê–ì 3: –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –ö–û–î–ï"

cd "${PROJECT_DIR}"
log "INFO" "–ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞: ${PROJECT_DIR}"

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π –≤–µ—Ç–∫–µ
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
print_color "${COLOR_YELLOW}" "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: ${CURRENT_BRANCH}"

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω—É—é –≤–µ—Ç–∫—É, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
if [ "${CURRENT_BRANCH}" != "${DEPLOY_BRANCH}" ]; then
    print_color "${COLOR_YELLOW}" "üîÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É ${DEPLOY_BRANCH}..."
    git checkout "${DEPLOY_BRANCH}"
    log "INFO" "–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –≤–µ—Ç–∫—É ${DEPLOY_BRANCH}"
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç
BEFORE_COMMIT=$(git rev-parse HEAD)
print_color "${COLOR_YELLOW}" "üìå –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: ${BEFORE_COMMIT:0:7}"

# –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
print_color "${COLOR_YELLOW}" "‚¨áÔ∏è  –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git fetch origin "${DEPLOY_BRANCH}"
log "INFO" "Git fetch –≤—ã–ø–æ–ª–Ω–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–º–º–∏—Ç–æ–≤
AFTER_COMMIT=$(git rev-parse origin/${DEPLOY_BRANCH})

if [ "${BEFORE_COMMIT}" == "${AFTER_COMMIT}" ]; then
    if [ "${CHECK_CHANGES}" == "true" ]; then
        print_color "${COLOR_YELLOW}" "‚ÑπÔ∏è  –ù–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        print_color "${COLOR_YELLOW}" "   –î–µ–ø–ª–æ–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
        log "INFO" "–ù–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç, –¥–µ–ø–ª–æ–π –ø—Ä–æ–ø—É—â–µ–Ω"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ñ–ª–∞–≥ force
        if [ "${1}" != "--force" ] && [ "${1}" != "-f" ]; then
            print_color "${COLOR_CYAN}" "\nüí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ --force –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è"
            exit 0
        else
            print_color "${COLOR_YELLOW}" "‚ö†Ô∏è  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π (—Ñ–ª–∞–≥ --force)"
            log "INFO" "–ó–∞–ø—É—â–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π"
        fi
    fi
else
    print_color "${COLOR_GREEN}" "‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    print_color "${COLOR_CYAN}" "   ${BEFORE_COMMIT:0:7} ‚Üí ${AFTER_COMMIT:0:7}"
    log "INFO" "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–º–º–∏—Ç—ã: ${BEFORE_COMMIT:0:7} -> ${AFTER_COMMIT:0:7}"
fi

# –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
print_color "${COLOR_YELLOW}" "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git pull origin "${DEPLOY_BRANCH}"
log "INFO" "Git pull –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç
LAST_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
print_color "${COLOR_GREEN}" "‚úì –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: ${LAST_COMMIT_MSG}"
print_color "${COLOR_GREEN}" "  –ê–≤—Ç–æ—Ä: ${LAST_COMMIT_AUTHOR}"
log "INFO" "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: ${LAST_COMMIT_MSG} (${LAST_COMMIT_AUTHOR})"

#-----------------------------------------------------------------------------
# –®–ê–ì 4: –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
#-----------------------------------------------------------------------------

if [ "${RUN_TESTS}" == "true" ]; then
    print_section "üß™ –®–ê–ì 4: –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í"
    
    log "INFO" "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
    print_color "${COLOR_YELLOW}" "‚è≥ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤..."
    
    if ${TEST_CMD}; then
        print_color "${COLOR_GREEN}" "‚úì –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
        log "INFO" "–¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
    else
        print_color "${COLOR_RED}" "‚ùå –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
        log "ERROR" "–¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
        exit 1
    fi
else
    log "INFO" "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω (RUN_TESTS=false)"
fi

#-----------------------------------------------------------------------------
# –®–ê–ì 5: –°–ë–û–†–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
#-----------------------------------------------------------------------------

print_section "üî® –®–ê–ì 5: –°–ë–û–†–ö–ê FLUTTER WEB –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø"

log "INFO" "–ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"

# –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –±–∏–ª–¥–æ–º
if [ "${CLEAN_BEFORE_BUILD}" == "true" ]; then
    print_color "${COLOR_YELLOW}" "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–∏–ª–¥–∞..."
    flutter clean
    log "INFO" "Flutter clean –≤—ã–ø–æ–ª–Ω–µ–Ω"
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
print_color "${COLOR_YELLOW}" "üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
flutter pub get
log "INFO" "Flutter pub get –≤—ã–ø–æ–ª–Ω–µ–Ω"

# –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
print_color "${COLOR_YELLOW}" "‚öôÔ∏è  –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)..."
log "INFO" "–ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã: ${FLUTTER_BUILD_CMD} ${FLUTTER_BUILD_FLAGS}"

if ${FLUTTER_BUILD_CMD} ${FLUTTER_BUILD_FLAGS}; then
    print_color "${COLOR_GREEN}" "‚úì –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    log "INFO" "–°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    print_color "${COLOR_RED}" "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!"
    log "ERROR" "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤ –±–∏–ª–¥–∞
if [ ! -d "${BUILD_DIR}" ]; then
    print_color "${COLOR_RED}" "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–∏–ª–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${BUILD_DIR}"
    log "ERROR" "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–∏–ª–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏"
    exit 1
fi

BUILD_SIZE=$(du -sh "${BUILD_DIR}" | cut -f1)
print_color "${COLOR_GREEN}" "üì¶ –†–∞–∑–º–µ—Ä –±–∏–ª–¥–∞: ${BUILD_SIZE}"
log "INFO" "–†–∞–∑–º–µ—Ä –±–∏–ª–¥–∞: ${BUILD_SIZE}"

#-----------------------------------------------------------------------------
# –®–ê–ì 6: –°–û–ó–î–ê–ù–ò–ï –†–ï–ó–ï–†–í–ù–û–ô –ö–û–ü–ò–ò
#-----------------------------------------------------------------------------

if [ "${CREATE_BACKUP}" == "true" ]; then
    print_section "üíæ –®–ê–ì 6: –°–û–ó–î–ê–ù–ò–ï –†–ï–ó–ï–†–í–ù–û–ô –ö–û–ü–ò–ò"
    
    log "INFO" "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    
    BACKUP_NAME="backup_${TIMESTAMP}.tar.gz"
    print_color "${COLOR_YELLOW}" "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${BACKUP_NAME}..."
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    ${SSH_CMD} "cd ${SERVER_WEB_DIR} && tar -czf /tmp/${BACKUP_NAME} . 2>/dev/null || true"
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
    if [ -n "${SSH_HOST_ALIAS}" ]; then
        scp "${SSH_HOST_ALIAS}:/tmp/${BACKUP_NAME}" "${BACKUP_DIR}/" &> /dev/null || true
    else
        ${SCP_CMD} "${SERVER_USER}@${SERVER_IP}:/tmp/${BACKUP_NAME}" "${BACKUP_DIR}/" &> /dev/null || true
    fi
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å —Å–µ—Ä–≤–µ—Ä–∞
    ${SSH_CMD} "rm -f /tmp/${BACKUP_NAME}"
    
    if [ -f "${BACKUP_DIR}/${BACKUP_NAME}" ]; then
        print_color "${COLOR_GREEN}" "‚úì –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${BACKUP_DIR}/${BACKUP_NAME}"
        log "INFO" "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    else
        print_color "${COLOR_YELLOW}" "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (–≤–æ–∑–º–æ–∂–Ω–æ, –ø–µ—Ä–≤—ã–π –¥–µ–ø–ª–æ–π)"
        log "WARNING" "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
    fi
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
    BACKUP_COUNT=$(ls -1 "${BACKUP_DIR}" | wc -l)
    if [ ${BACKUP_COUNT} -gt ${MAX_BACKUPS} ]; then
        print_color "${COLOR_YELLOW}" "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
        cd "${BACKUP_DIR}"
        ls -t | tail -n +$((MAX_BACKUPS + 1)) | xargs rm -f
        log "INFO" "–°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —É–¥–∞–ª–µ–Ω—ã"
    fi
else
    log "INFO" "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—Ä–æ–ø—É—â–µ–Ω–æ (CREATE_BACKUP=false)"
fi

#-----------------------------------------------------------------------------
# –®–ê–ì 7: –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í –ù–ê –°–ï–†–í–ï–†
#-----------------------------------------------------------------------------

print_section "üì§ –®–ê–ì 7: –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í –ù–ê –°–ï–†–í–ï–†"

log "INFO" "–ù–∞—á–∞–ª–æ –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
print_color "${COLOR_YELLOW}" "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
${SSH_CMD} "rm -rf ${SERVER_WEB_DIR}/*"
log "INFO" "–°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞"

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
print_color "${COLOR_YELLOW}" "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

if [ -n "${SSH_HOST_ALIAS}" ]; then
    rsync -avz --progress "${BUILD_DIR}/" "${SSH_HOST_ALIAS}:${SERVER_WEB_DIR}/"
else
    rsync -avz --progress -e "ssh -p ${SSH_PORT}" "${BUILD_DIR}/" "${SERVER_USER}@${SERVER_IP}:${SERVER_WEB_DIR}/"
fi

print_color "${COLOR_GREEN}" "‚úì –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
log "INFO" "–§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
print_color "${COLOR_YELLOW}" "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
${SSH_CMD} "chmod -R 755 ${SERVER_WEB_DIR}"
log "INFO" "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

#-----------------------------------------------------------------------------
# –®–ê–ì 8: –ü–ï–†–ï–ó–ê–ü–£–°–ö NGINX
#-----------------------------------------------------------------------------

if [ "${RESTART_NGINX}" == "true" ]; then
    print_section "üîÑ –®–ê–ì 8: –ü–ï–†–ï–ó–ê–ü–£–°–ö NGINX"
    
    log "INFO" "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
    print_color "${COLOR_YELLOW}" "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx..."
    if ${SSH_CMD} "nginx -t" &> /dev/null; then
        print_color "${COLOR_GREEN}" "‚úì –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
        log "INFO" "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
    else
        print_color "${COLOR_RED}" "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx!"
        log "ERROR" "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx"
        exit 1
    fi
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º nginx
    print_color "${COLOR_YELLOW}" "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx..."
    ${SSH_CMD} "systemctl restart nginx"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å nginx
    if ${SSH_CMD} "systemctl is-active --quiet nginx"; then
        print_color "${COLOR_GREEN}" "‚úì Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
        log "INFO" "Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        print_color "${COLOR_RED}" "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ nginx!"
        log "ERROR" "Nginx –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
        exit 1
    fi
else
    log "INFO" "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx –ø—Ä–æ–ø—É—â–µ–Ω (RESTART_NGINX=false)"
fi

#-----------------------------------------------------------------------------
# –®–ê–ì 9: –ü–†–û–í–ï–†–ö–ê –î–ï–ü–õ–û–Ø
#-----------------------------------------------------------------------------

print_section "‚úÖ –®–ê–ì 9: –ü–†–û–í–ï–†–ö–ê –î–ï–ü–õ–û–Ø"

log "INFO" "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"

# –î–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞
print_color "${COLOR_YELLOW}" "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ https://${SERVER_IP}..."

HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${SERVER_IP}" --insecure || echo "000")

if [ "${HTTP_CODE}" == "200" ]; then
    print_color "${COLOR_GREEN}" "‚úì –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP ${HTTP_CODE})"
    log "INFO" "–°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞: ${HTTP_CODE}"
elif [ "${HTTP_CODE}" == "000" ]; then
    print_color "${COLOR_RED}" "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∞–π—Ç—É"
    log "ERROR" "–°–∞–π—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
else
    print_color "${COLOR_YELLOW}" "‚ö†Ô∏è  –°–∞–π—Ç –≤–µ—Ä–Ω—É–ª –∫–æ–¥ ${HTTP_CODE}"
    log "WARNING" "–°–∞–π—Ç –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –∫–æ–¥: ${HTTP_CODE}"
fi

#-----------------------------------------------------------------------------
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
#-----------------------------------------------------------------------------

print_section "üéâ –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"

DEPLOY_DURATION=$((SECONDS))
DEPLOY_MINUTES=$((DEPLOY_DURATION / 60))
DEPLOY_SECONDS=$((DEPLOY_DURATION % 60))

print_color "${COLOR_GREEN}" "‚úì –î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ ${DEPLOY_MINUTES} –º–∏–Ω ${DEPLOY_SECONDS} —Å–µ–∫"
print_color "${COLOR_GREEN}" "‚úì –õ–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${LOG_FILE_PATH}"
print_color "${COLOR_CYAN}" "\nüåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
print_color "${COLOR_CYAN}" "   https://${SERVER_IP}"

log "INFO" "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞ ${DEPLOY_MINUTES}:${DEPLOY_SECONDS}"

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤
LOG_COUNT=$(ls -1 "${LOG_DIR}" | wc -l)
if [ ${LOG_COUNT} -gt ${MAX_LOGS} ]; then
    cd "${LOG_DIR}"
    ls -t | tail -n +$((MAX_LOGS + 1)) | xargs rm -f
    log "INFO" "–°—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã"
fi

# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
if [ -n "${NOTIFICATION_EMAIL}" ]; then
    send_email_notification "SUCCESS" "–î–µ–ø–ª–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ ${DEPLOY_MINUTES}:${DEPLOY_SECONDS}"
fi

print_color "${COLOR_PURPLE}" "\nüí° Tip: –ó–∞–ø—É—Å—Ç–∏—Ç–µ './check_deployment.sh' –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏"

exit 0
