# Журнал разработки Video Marketplace App

## Сессия 28 декабря 2024

### Обсуждение концепции проекта

**Концепция:** Платформа для оптовых рынков города. Продавцы с рынков выставляют товары, покупатели заказывают, курьеры доставляют напрямую (как доставка еды).

**4 роли в системе:**
1. **Продавец** - выставляет рилсы, истории, карточки товаров, общается с покупателями
2. **Покупатель** - смотрит контент, ищет товары, заказывает, отслеживает доставку
3. **Курьер** - видит заказы, забирает у продавца, доставляет покупателю
4. **Админ** - видит всё, модерирует, может создавать рилсы/истории для рекламы

### Ключевые решения

| Решение | Выбор | Причина |
|---------|-------|---------|
| Дизайн | Instagram-style | Кружочки историй, Explore-сетка в поиске |
| Оплата | Наличка курьеру (COD) | Простой старт, онлайн-оплата позже |
| Доставка | Только через курьеров | Не самовывоз |
| Чат | В приложении | Продавец <-> Покупатель |
| Локация | При регистрации | Клик -> навигатор (Google Maps/Yandex) |
| Статус заказа | Виден всем участникам | Прозрачность процесса |

### Технические решения

- **Frontend:** Flutter (один app с 4 ролями)
- **Backend:** DigitalOcean (App Platform + Spaces + Managed DB)
- **База данных:** PostgreSQL
- **Хранилище видео:** DigitalOcean Spaces

### Что сделано сегодня

1. Создан демо-режим для тестирования UI без Firebase
2. Обновлены зависимости для совместимости с Flutter SDK
3. Собран демо-APK (22.6 MB)
4. Согласован план MVP на 4-5 недель
5. Определены все роли и функционал

### Следующие шаги

1. Создать архитектуру базы данных
2. Настроить backend на DigitalOcean
3. Реализовать авторизацию с ролями
4. Начать разработку по ТЗ

---

## Сессия 28 декабря 2024 (продолжение) - Post-MVP улучшения

### Собранные требования по ролям

**ПРОДАВЕЦ:**
- Принять/отклонить заказ (кнопки) - ДА
- Статистика (выручка, топ товары) - ДА
- Управление остатками товара - ДА

**ПОКУПАТЕЛЬ:**
- Несколько адресов доставки (дом/работа) - ДА
- Избранное (сохранённые товары) - ДА
- Кнопка "Проблема с заказом" (жалоба) - ДА
- Убрать вкладку "Создать" - ДА

**КУРЬЕР:**
- Uber-принцип (сам берёт заказы) - ДА
- Онлайн-статус (на смене) - ДА
- Показывать заработок - ДА

**АДМИН:**
- Верификация продавцов (через админа) - ДА
- Уведомления о жалобах - ДА

### Дополнительные требования

- **Цвета:** Оранжевый (#FF6B00), Белый, Чёрный
- **Языки:** Узбекский, Русский, Английский
- **Кабинет:** Отдельный раздел в профиле
- **Тариф доставки:** Добавить позже
- **Таймер на принятие заказа:** Добавить позже
- **Push-уведомления:** Добавить позже
- **Геолокация с картой:** Добавить позже

### Главные экраны по ролям

**Покупатель:** Лента → Поиск → Заказы → Профиль (4 вкладки, без "Создать")
**Продавец:** Лента → Поиск → Создать → Заказы → Профиль (5 вкладок)
**Курьер:** Доступные → Активные → История → Профиль
**Админ:** Дашборд → Пользователи → Заказы → Контент

### Что сделано

1. Обновлена цветовая схема (оранжевый акцент)
2. Убрана вкладка "Создать" у покупателя
3. Добавлен EditProfileScreen с загрузкой аватара
4. Добавлен StoryViewerScreen для полноэкранного просмотра историй
5. Обновлено ТЗ с новыми требованиями
6. Добавлены кабинеты по ролям (SellerCabinet, BuyerCabinet)
7. Добавлена локализация (узб/рус/англ)
8. Добавлен тариф доставки (стандарт/экспресс)
9. Добавлен таймер на принятие заказа (5 минут)
10. Добавлены push-уведомления (NotificationService)
11. Добавлена геолокация с расчётом расстояния (LocationService)
12. Курьер видит расстояние до продавца/покупателя
13. Кнопка навигации открывает Google Maps/Яндекс Карты

### Коммиты

- `00a099d` - Add push notifications and geolocation with distance calculation and navigation
- `308c240` - Add delivery tariff and order acceptance timer
- `3e9953e` - Add role-specific cabinet screens with localization

---

## Предыдущие сессии

### 24 декабря 2024
- Исправлена загрузка видео (null-safety, обработка ошибок)
- Исправлен просмотр профиля (проверки авторизации)
- Добавлены snackbar уведомления об ошибках
- Создан детальный отчёт FIXES_REPORT.md

---

## Сессия 30 декабря 2025 — Деплой и критические багфиксы (prod 165.232.81.31)

### Контекст
- На проде наблюдаются проблемы: **серый экран “Заказы”** и **зависание оформления заказа**.
- Цель: выкатить **минимальный набор критических фиксов** отдельным PR и понять, **как именно деплоится** сервер `165.232.81.31`.

### Что выяснили (GitHub)
- Репозиторий: `buranovt2025-jpg/video-marketplace-app`.
- **Default branch = `feature/initial-upload`** (важно для понимания, что “скорее всего” именно она и деплоится, но это нужно подтвердить на сервере).
- PR **#1**: `devin/1766935961-postgresql-backend` → base: `feature/initial-upload`, state: **OPEN**, mergeable: **MERGEABLE**.
- Важно: PR #1 **не является “только багфиксами”** — он содержит большой объём изменений (backend + множество фич/рефакторинга и пр.), поэтому для “быстрого и безопасного” деплоя критических фиксов рекомендуется вынести багфиксы в отдельный маленький PR.

### План действий (без смешивания багфиксов/рефакторинга/фич)
1) **PR (hotfix) только с критическими фикcами**:
   - исправление загрузки/обновления вкладки “Заказы” (убрать серый экран),
   - исправление зависания checkout (правильная обработка loading + навигация + таймауты/ошибки).
2) **Определить реальный механизм деплоя** на `165.232.81.31`:
   - понять, что именно деплоится (Flutter Web статика / Docker / systemd),
   - определить, какая ветка и какой commit сейчас на сервере.
3) **Добавить отображение версии/commit hash в UI** (маленький отдельный PR), чтобы сразу видеть, “задеплоилось или нет”.
4) После стабилизации:
   - отдельный PR с рефакторингом,
   - отдельный PR с фичами поиска.

### Минимальные команды для проверки сервера (SSH)
Цель: без догадок определить root статики nginx / наличие git-репы / systemd или docker деплой.
- `sudo nginx -T | rg -n "server_name|root |proxy_pass|location /"`
- `curl -kI https://165.232.81.31/`
- Поиск кода: `ls -la /opt /srv /var/www /home`
- Если найдена репа: `git rev-parse HEAD && git branch --show-current && git log -1 --oneline --decorate`
- systemd: `systemctl list-units --type=service --state=running | rg -i "uvicorn|fastapi|backend|api"`
- docker: `docker ps` / `docker compose ls`

### Ожидаемый результат
- Понимаем, **что именно** и **откуда** деплоится на `165.232.81.31`.
- Деплоим **минимальный hotfix** и подтверждаем его попадание на прод (через build stamp/commit hash в UI).

### Дополнительно (чтобы деплой был “в 1 команду”)
- Добавлены скрипты:
  - `scripts/deploy_web.sh`: `flutter pub get` → `flutter build web --release` → rsync в `/var/www/gogomarket` → `nginx reload`, запись `.last_build_id`.
  - `scripts/build_apk.sh`: сборка release APK и вывод пути к артефактам.
- Добавлен web-build фикс для QR/`mobile_scanner`:
  - `lib/views/screens/common/qr_scanner_export.dart` + `qr_scanner_screen_stub.dart` (на web используется заглушка, на mobile — реальный экран),
  - `CourierOrderDetailScreen` импортирует `qr_scanner_export.dart`,
  - в `deploy_web.sh` делается временный патч *pub-cache* `mobile_scanner` (отключается `platforms.web` в `pubspec.yaml`) только на время сборки web, чтобы избежать конфликта `ImageCapture` в `dart:html`.

### Что подтвердили на сервере (DigitalOcean droplet)
- Nginx раздаёт Flutter Web статику из: `/var/www/gogomarket` (git-репы там нет).
- API роуты `/api`, `/ws`, `/healthz` проксируются на `127.0.0.1:8000`.
- Для быстрой проверки деплоя используется:
  - `/var/www/gogomarket/version.json`
  - `/var/www/gogomarket/.last_build_id`

### Операционные решения/“фишки”
- Чтобы не “копировать простыни команд”, выбрали подход: **1 команда на сервере** через `scripts/deploy_web.sh` / `scripts/build_apk.sh`.
- SSH для пользователя `deploy` включали по паролю (test env) через `PasswordAuthentication yes` в `/etc/ssh/sshd_config.d/50-cloud-init.conf` и `60-cloudimg-settings.conf`.
- В процессе выяснили, что попытки “чинить web сборку” через хаотичные `dependency_overrides` и ручные правки на сервере приводят к кругам; правильный путь — фиксировать проблему в репозитории и деплоить повторяемым скриптом.

### Сессия (продолжение) — фиксы для web-сборки (Dart 3.10.4 / Flutter 3.38.5)
- Зафиксировали проблему: `flutter build web --release` падал с ошибками уровня JS interop (например: *"JSObject can't be used as supertype"*), а также конфликтами web-плагинов.
- Решение: закрепить совместимые версии транзитивных пакетов через `dependency_overrides` в `pubspec.yaml`:
  - `web: ^1.1.1`
  - `http: ^1.6.0`
  - `image_picker_platform_interface: ^2.11.1`
- Ожидаемый эффект: стабилизировать web-компиляцию и убрать ошибки API несовместимости.

---

## Сессия 30 декабря 2025 (Devin) — Попытка деплоя и обнаружение Firebase несовместимости

### Контекст
- Devin подключился к серверу `165.232.81.31` через DigitalOcean API (сброс пароля)
- Цель: задеплоить web-билд с фиксами Cursor

### Что сделано (Devin)

1. **Подключение к серверу:**
   - Использован DO API токен для сброса пароля root
   - SSH доступ получен успешно

2. **Исправлен mobile_scanner конфликт:**
   - Создан stub-пакет в `packages/mobile_scanner/`
   - Убраны native platform declarations (android/ios/macos) из pubspec.yaml пакета
   - Это устранило ошибку "ImageCapture conflicts with dart:html"

3. **Исправлена ошибка Android plugin:**
   - Ошибка: "mobile_scanner doesn't have a main class defined"
   - Решение: убраны все flutter.plugin.platforms из pubspec.yaml stub-пакета

4. **Обнаружена критическая проблема — Firebase несовместимость:**
   - Ошибка: `The method 'callMethod' isn't defined for the type '_FieldValueDelete'`
   - Причина: `cloud_firestore_web-3.10.8` использует устаревший `js` API
   - Пакет несовместим с Flutter 3.38.5 / Dart 3.10.4

### Блокирующая проблема

Firebase пакеты в проекте устарели и несовместимы с текущей версией Flutter:
- `cloud_firestore: ^4.13.0` → нужно `^5.0.0`
- `firebase_auth: ^4.15.0` → нужно `^5.0.0`
- `firebase_core: ^2.24.0` → нужно `^3.0.0`
- `firebase_messaging: ^14.7.19` → нужно `^15.0.0`
- `firebase_storage: ^11.5.0` → нужно `^12.0.0`

### Следующие шаги (для Cursor)

1. Обновить Firebase пакеты до версий совместимых с Dart 3.10.4
2. Проверить что код совместим с новыми API Firebase
3. Протестировать `flutter build web --release` локально
4. Закоммитить изменения

### После фикса Cursor

Devin задеплоит обновлённый код на сервер:
```bash
cd /root/projects/video-marketplace-app
git pull origin cursor/what-has-been-done-5e03
flutter clean && flutter pub get && flutter build web --release
bash scripts/deploy_web.sh
```
