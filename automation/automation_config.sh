#!/bin/bash

################################################################################
# КОНФИГУРАЦИЯ СИСТЕМЫ АВТОМАТИЗАЦИИ CURSOR
################################################################################
# Этот файл содержит все настройки для автоматической системы коммитов и деплоя
# Изменяйте параметры здесь, чтобы настроить поведение автоматизации
################################################################################

# ============================================================================
# ОСНОВНЫЕ НАСТРОЙКИ ПРОЕКТА
# ============================================================================

# Название проекта
export PROJECT_NAME="GoGoMarket"

# Путь к проекту (где находится .git)
export PROJECT_PATH="/home/ubuntu/video-marketplace-app"

# Репозиторий GitHub
export GITHUB_REPO="buranovt2025-jpg/video-marketplace-app"

# URL репозитория
export GITHUB_URL="https://github.com/$GITHUB_REPO"

# ============================================================================
# НАСТРОЙКИ ВЕТОК
# ============================================================================

# Ветки, которые автоматически деплоятся на сервер
export AUTO_DEPLOY_BRANCHES=("main" "production")

# Ветка по умолчанию
export DEFAULT_BRANCH="main"

# Ветки, которые требуют review перед merge
export REVIEW_REQUIRED_BRANCHES=("main" "production")

# ============================================================================
# НАСТРОЙКИ КОММИТОВ
# ============================================================================

# Минимальное время между автоматическими коммитами (в секундах)
# Это предотвращает слишком частые коммиты
export MIN_COMMIT_INTERVAL=60  # 1 минута

# Максимальное количество файлов в одном коммите
# Если изменений больше - будет предупреждение
export MAX_FILES_PER_COMMIT=20

# Автоматически добавлять все изменения в коммит
export AUTO_ADD_ALL=true

# Использовать conventional commits формат
export USE_CONVENTIONAL_COMMITS=true

# Типы коммитов и их приоритеты (для автоопределения)
declare -A COMMIT_TYPES
COMMIT_TYPES=(
    ["fix"]=10        # Исправление бага - высокий приоритет
    ["feat"]=9        # Новая функциональность
    ["refactor"]=7    # Рефакторинг
    ["perf"]=8        # Улучшение производительности
    ["style"]=5       # Форматирование
    ["docs"]=4        # Документация
    ["test"]=6        # Тесты
    ["build"]=5       # Сборка
    ["ci"]=5          # CI/CD
    ["chore"]=3       # Рутина
)
export COMMIT_TYPES

# ============================================================================
# НАСТРОЙКИ АВТОМАТИЧЕСКОГО ОПРЕДЕЛЕНИЯ ТИПА КОММИТА
# ============================================================================

# Ключевые слова для определения типа изменений

# fix: - ключевые слова для багфиксов
export FIX_KEYWORDS=("fix" "bug" "error" "issue" "problem" "crash" "исправл" "ошибк" "баг")

# feat: - ключевые слова для новых фич
export FEAT_KEYWORDS=("add" "new" "feature" "implement" "создан" "добавл" "нов")

# refactor: - ключевые слова для рефакторинга
export REFACTOR_KEYWORDS=("refactor" "clean" "improve" "optimize" "рефактор" "улучш" "оптимиз")

# docs: - ключевые слова для документации
export DOCS_KEYWORDS=("doc" "readme" "comment" "документ")

# style: - ключевые слова для стилей
export STYLE_KEYWORDS=("style" "format" "indent" "whitespace" "стиль" "формат")

# test: - ключевые слова для тестов
export TEST_KEYWORDS=("test" "spec" "тест")

# ============================================================================
# НАСТРОЙКИ ПУША
# ============================================================================

# Автоматически пушить после коммита
export AUTO_PUSH=true

# Использовать force push (ОПАСНО! Используйте только если знаете что делаете)
export ALLOW_FORCE_PUSH=false

# Проверять наличие конфликтов перед пушем
export CHECK_CONFLICTS=true

# Делать pull перед пушем
export PULL_BEFORE_PUSH=true

# Использовать rebase вместо merge при pull
export USE_REBASE=true

# ============================================================================
# НАСТРОЙКИ ДЕПЛОЯ
# ============================================================================

# Сервер для деплоя
export DEPLOY_SERVER="165.232.81.31"

# Пользователь для SSH
export DEPLOY_USER="root"

# Путь на сервере
export DEPLOY_PATH="/var/www/gogomarket"

# Путь к скриптам деплоя
export DEPLOY_SCRIPTS_PATH="/home/ubuntu/cursor_deploy_automation"

# Автоматически деплоить после пуша (только для указанных веток)
export AUTO_DEPLOY=false  # GitHub Actions делает это автоматически

# ============================================================================
# НАСТРОЙКИ ЛОГИРОВАНИЯ
# ============================================================================

# Директория для логов
export LOG_DIR="/home/ubuntu/cursor_automation/logs"

# Файл основного лога
export LOG_FILE="$LOG_DIR/automation.log"

# Файл лога коммитов
export COMMIT_LOG="$LOG_DIR/commits.log"

# Файл лога ошибок
export ERROR_LOG="$LOG_DIR/errors.log"

# Максимальный размер лог-файла (в MB)
export MAX_LOG_SIZE=10

# Количество старых логов для хранения
export LOG_ROTATE_COUNT=5

# Уровень логирования (DEBUG, INFO, WARN, ERROR)
export LOG_LEVEL="INFO"

# Включить цветной вывод в консоль
export COLOR_OUTPUT=true

# ============================================================================
# НАСТРОЙКИ УВЕДОМЛЕНИЙ
# ============================================================================

# Показывать уведомления в системе
export SHOW_NOTIFICATIONS=true

# Отправлять уведомления на email (требует настройки)
export EMAIL_NOTIFICATIONS=false
export EMAIL_TO=""

# Отправлять уведомления в Slack (требует настройки)
export SLACK_NOTIFICATIONS=false
export SLACK_WEBHOOK=""

# Отправлять уведомления в Telegram (требует настройки)
export TELEGRAM_NOTIFICATIONS=false
export TELEGRAM_BOT_TOKEN=""
export TELEGRAM_CHAT_ID=""

# ============================================================================
# НАСТРОЙКИ БЕЗОПАСНОСТИ
# ============================================================================

# Проверять наличие секретов в коммите
export CHECK_SECRETS=true

# Паттерны для поиска секретов
export SECRET_PATTERNS=(
    "password"
    "api_key"
    "api-key"
    "apikey"
    "secret"
    "token"
    "private_key"
    "private-key"
    "credential"
    "passwd"
)

# Файлы, которые никогда не должны быть в коммите
export FORBIDDEN_FILES=(
    ".env"
    "*.key"
    "*.pem"
    "id_rsa"
    "*.pfx"
    "*.p12"
)

# ============================================================================
# НАСТРОЙКИ ПРОВЕРОК ПЕРЕД КОММИТОМ
# ============================================================================

# Запускать линтер перед коммитом
export RUN_LINTER=false  # Можно включить для строгих проверок

# Запускать тесты перед коммитом
export RUN_TESTS=false  # Можно включить, если есть быстрые тесты

# Запускать форматтер перед коммитом
export RUN_FORMATTER=false  # Можно включить для автоформатирования

# Проверять наличие TODO комментариев
export CHECK_TODOS=false

# ============================================================================
# НАСТРОЙКИ МОНИТОРИНГА ФАЙЛОВ (для watch_and_deploy.sh)
# ============================================================================

# Директории для мониторинга (относительно PROJECT_PATH)
export WATCH_DIRS=("lib" "web" "pubspec.yaml")

# Игнорировать эти директории
export IGNORE_DIRS=(".git" "build" ".dart_tool" "node_modules")

# Расширения файлов для мониторинга
export WATCH_EXTENSIONS=("dart" "yaml" "json" "html" "css" "js")

# Задержка перед автокоммитом после изменения (в секундах)
export WATCH_DELAY=5

# ============================================================================
# ФЛАГИ ВКЛЮЧЕНИЯ/ВЫКЛЮЧЕНИЯ ФУНКЦИЙ
# ============================================================================

# Включить автоматическую систему
export AUTOMATION_ENABLED=true

# Включить автоматические коммиты
export AUTO_COMMIT_ENABLED=true

# Включить автоматический пуш
export AUTO_PUSH_ENABLED=true

# Включить мониторинг файлов (watch mode)
export WATCH_MODE_ENABLED=false  # Включать вручную при необходимости

# Включить debug режим (подробный вывод)
export DEBUG_MODE=false

# ============================================================================
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
# ============================================================================

# Timeout для git операций (в секундах)
export GIT_TIMEOUT=30

# Количество попыток при ошибке пуша
export PUSH_RETRY_COUNT=3

# Задержка между попытками (в секундах)
export RETRY_DELAY=5

# Создавать backup перед опасными операциями
export CREATE_BACKUPS=true

# Директория для backup'ов
export BACKUP_DIR="/home/ubuntu/cursor_automation/backups"

# ============================================================================
# ЦВЕТА ДЛЯ КОНСОЛЬНОГО ВЫВОДА
# ============================================================================

export COLOR_RESET="\033[0m"
export COLOR_RED="\033[0;31m"
export COLOR_GREEN="\033[0;32m"
export COLOR_YELLOW="\033[0;33m"
export COLOR_BLUE="\033[0;34m"
export COLOR_MAGENTA="\033[0;35m"
export COLOR_CYAN="\033[0;36m"
export COLOR_WHITE="\033[0;37m"
export COLOR_BOLD="\033[1m"

# ============================================================================
# ФУНКЦИИ ПОМОЩНИКИ
# ============================================================================

# Функция для проверки, нужен ли автоматический деплой для текущей ветки
should_auto_deploy() {
    local current_branch=$(git branch --show-current 2>/dev/null)
    for branch in "${AUTO_DEPLOY_BRANCHES[@]}"; do
        if [[ "$current_branch" == "$branch" ]]; then
            return 0
        fi
    done
    return 1
}

# Функция для проверки, является ли файл запрещенным
is_forbidden_file() {
    local file="$1"
    for pattern in "${FORBIDDEN_FILES[@]}"; do
        if [[ "$file" == $pattern ]]; then
            return 0
        fi
    done
    return 1
}

# Функция для вывода цветного текста
print_color() {
    local color="$1"
    local message="$2"
    if [[ "$COLOR_OUTPUT" == "true" ]]; then
        echo -e "${color}${message}${COLOR_RESET}"
    else
        echo "$message"
    fi
}

################################################################################
# КОНЕЦ КОНФИГУРАЦИИ
################################################################################

# Создать необходимые директории если их нет
mkdir -p "$LOG_DIR" 2>/dev/null
mkdir -p "$BACKUP_DIR" 2>/dev/null

# Вывести сообщение о загрузке конфигурации
if [[ "$DEBUG_MODE" == "true" ]]; then
    print_color "$COLOR_GREEN" "[CONFIG] Конфигурация автоматизации загружена успешно"
fi
