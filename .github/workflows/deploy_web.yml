name: Deploy Flutter Web (SSH)

on:
  push:
    branches:
      # Change this to the branch you want to auto-deploy.
      - cursor/what-has-been-done-5e03

concurrency:
  group: deploy-web-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy on server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PROJECT_DIR: ${{ secrets.DEPLOY_PROJECT_DIR }}
          DEPLOY_BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          echo "Deploying branch: ${DEPLOY_BRANCH}"
          echo "Server: ${DEPLOY_USER}@${DEPLOY_HOST}"
          ssh "${DEPLOY_USER}@${DEPLOY_HOST}" "bash -lc '
            set -euo pipefail
            PROJECT_DIR=\"${DEPLOY_PROJECT_DIR:-/root/projects/video-marketplace-app}\"
            cd \"${PROJECT_DIR}\"
            git fetch origin
            git checkout \"${DEPLOY_BRANCH}\"
            git pull origin \"${DEPLOY_BRANCH}\"
            bash scripts/deploy_web.sh
          '"

