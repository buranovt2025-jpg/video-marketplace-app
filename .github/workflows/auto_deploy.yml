name: üöÄ Auto Deploy to Digital Ocean

# –¢—Ä–∏–≥–≥–µ—Ä: –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
on:
  push:
    branches:
      - '**'  # –í—Å–µ –≤–µ—Ç–∫–∏
  pull_request:
    branches:
      - main
      - production

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
env:
  FLUTTER_VERSION: '3.16.0'
  NODE_VERSION: '18'
  DEPLOY_SERVER: '165.232.81.31'
  DEPLOY_USER: 'root'
  DEPLOY_PATH: '/var/www/gogomarket'
  PROJECT_NAME: 'GoGoMarket'

jobs:
  # ============================================================================
  # JOB 1: –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê
  # ============================================================================
  code-check:
    name: üîç Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
      
      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Get dependencies
        run: flutter pub get
      
      - name: üîç Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true  # –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –Ω–∞ warnings
      
      - name: ‚úÖ Check formatting
        run: flutter format --set-exit-if-changed .
        continue-on-error: true
      
      - name: üìä Upload analysis results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: analysis-results
          path: |
            **/*.log
            analysis_results.txt
          retention-days: 7

  # ============================================================================
  # JOB 2: –°–ë–û–†–ö–ê FLUTTER WEB
  # ============================================================================
  build:
    name: üèóÔ∏è Build Flutter Web
    runs-on: ubuntu-latest
    needs: code-check
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: üì¶ Get dependencies
        run: flutter pub get
      
      - name: üèóÔ∏è Build Web App
        run: |
          echo "üöÄ –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∫–∏ Flutter web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          flutter build web --release --web-renderer html
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
      
      - name: üìä Check build size
        run: |
          echo "üì¶ –†–∞–∑–º–µ—Ä —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          du -sh build/web
          ls -lh build/web
      
      - name: üì§ Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: flutter-web-build
          path: build/web
          retention-days: 7
      
      - name: ‚úÖ Build summary
        run: |
          echo "### ‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–†–∞–∑–º–µ—Ä:** $(du -sh build/web | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**–§–∞–π–ª—ã:** $(find build/web -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # JOB 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  # ============================================================================
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    needs: code-check
    if: false  # –û—Ç–∫–ª—é—á–µ–Ω–æ, –≤–∫–ª—é—á–∏—Ç—å –∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è —Ç–µ—Å—Ç—ã
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üéØ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      
      - name: üì¶ Get dependencies
        run: flutter pub get
      
      - name: üß™ Run tests
        run: flutter test
      
      - name: üìä Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results/

  # ============================================================================
  # JOB 4: –î–ï–ü–õ–û–ô –ù–ê PRODUCTION (—Ç–æ–ª—å–∫–æ –¥–ª—è main/production –≤–µ—Ç–æ–∫)
  # ============================================================================
  deploy:
    name: üöÄ Deploy to Digital Ocean
    runs-on: ubuntu-latest
    needs: build
    # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –¥–ª—è main –∏ production –≤–µ—Ç–æ–∫
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'
    
    environment:
      name: production
      url: http://165.232.81.31
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üì¶ Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: flutter-web-build
          path: build/web
      
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DEPLOY_SERVER }} >> ~/.ssh/known_hosts
      
      - name: üß™ Test SSH connection
        run: |
          ssh -i ~/.ssh/id_rsa ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "echo '‚úÖ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'"
      
      - name: üì§ Deploy files to server
        run: |
          echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          
          # –°–æ–∑–¥–∞—Ç—å backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
          ssh -i ~/.ssh/id_rsa ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "
            if [ -d ${{ env.DEPLOY_PATH }} ]; then
              echo 'üì¶ –°–æ–∑–¥–∞–Ω–∏–µ backup —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏...'
              cp -r ${{ env.DEPLOY_PATH }} ${{ env.DEPLOY_PATH }}_backup_\$(date +%Y%m%d_%H%M%S)
              # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ backup (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
              ls -dt ${{ env.DEPLOY_PATH }}_backup_* | tail -n +6 | xargs rm -rf
            fi
            
            # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            mkdir -p ${{ env.DEPLOY_PATH }}
          "
          
          # –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
          echo "üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_rsa" \
            build/web/ \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
      
      - name: üîß Configure Nginx (if needed)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} << 'EOF'
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
            if ! nginx -t; then
              echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
            systemctl reload nginx || systemctl restart nginx
            
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
            if systemctl is-active --quiet nginx; then
              echo "‚úÖ Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
            else
              echo "‚ùå –û—à–∏–±–∫–∞: Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
              exit 1
            fi
          EOF
      
      - name: ‚úÖ Verify deployment
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è..."
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
          ssh -i ~/.ssh/id_rsa ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "
            if [ -f ${{ env.DEPLOY_PATH }}/index.html ]; then
              echo '‚úÖ index.html –Ω–∞–π–¥–µ–Ω'
            else
              echo '‚ùå index.html –Ω–µ –Ω–∞–π–¥–µ–Ω!'
              exit 1
            fi
            
            echo ''
            echo 'üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ø–ª–æ–µ:'
            echo '–†–∞–∑–º–µ—Ä: '\$(du -sh ${{ env.DEPLOY_PATH }} | cut -f1)
            echo '–§–∞–π–ª–æ–≤: '\$(find ${{ env.DEPLOY_PATH }} -type f | wc -l)
            echo '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: '\$(stat -c %y ${{ env.DEPLOY_PATH }}/index.html)
          "
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∞–π—Ç–∞
          echo ""
          echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∞–π—Ç–∞..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.DEPLOY_SERVER }})
          
          if [ "$response" == "200" ]; then
            echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $response)"
          else
            echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –°–∞–π—Ç –≤–µ—Ä–Ω—É–ª –∫–æ–¥ $response"
          fi
      
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
      
      - name: üìù Deployment summary
        run: |
          echo "### üöÄ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–°–µ—Ä–≤–µ—Ä:** ${{ env.DEPLOY_SERVER }}" >> $GITHUB_STEP_SUMMARY
          echo "**–ü—É—Ç—å:** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "**–í—Ä–µ–º—è:** $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**–ö–æ–º–º–∏—Ç:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üåê **URL:** http://${{ env.DEPLOY_SERVER }}" >> $GITHUB_STEP_SUMMARY
      
      - name: üì¢ Send notification (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if: success()
        run: |
          echo "‚úÖ –î–µ–ø–ª–æ–π ${{ env.PROJECT_NAME }} –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
          echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://${{ env.DEPLOY_SERVER }}"

  # ============================================================================
  # JOB 5: ROLLBACK –ü–†–ò –û–®–ò–ë–ö–ï
  # ============================================================================
  rollback:
    name: üîÑ Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DEPLOY_SERVER }} >> ~/.ssh/known_hosts
      
      - name: üîÑ Restore from backup
        run: |
          echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ backup..."
          
          ssh -i ~/.ssh/id_rsa ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} "
            # –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π backup
            LAST_BACKUP=\$(ls -dt ${{ env.DEPLOY_PATH }}_backup_* 2>/dev/null | head -1)
            
            if [ -n \"\$LAST_BACKUP\" ]; then
              echo 'üì¶ –ù–∞–π–¥–µ–Ω backup: '\$LAST_BACKUP
              
              # –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
              rm -rf ${{ env.DEPLOY_PATH }}
              
              # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ backup
              cp -r \"\$LAST_BACKUP\" ${{ env.DEPLOY_PATH }}
              
              # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å Nginx
              systemctl reload nginx
              
              echo '‚úÖ Rollback –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ'
            else
              echo '‚ùå Backup –Ω–µ –Ω–∞–π–¥–µ–Ω!'
              exit 1
            fi
          "
      
      - name: üßπ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
      
      - name: üìù Rollback summary
        run: |
          echo "### üîÑ Rollback –≤—ã–ø–æ–ª–Ω–µ–Ω" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è –î–µ–ø–ª–æ–π –±—ã–ª –Ω–µ—É—Å–ø–µ—à–Ω—ã–º –∏ —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é" >> $GITHUB_STEP_SUMMARY
