name: Flutter CI (PR checks)

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: flutter-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Analyze + Test + Web build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.5"
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Pub get
        run: flutter pub get

      - name: "Guard - no const + .tr"
        run: python3 scripts/check_no_const_tr.py

      - name: Format (verify)
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze
        run: flutter analyze

      - name: Test
        run: flutter test

      - name: Build web (release)
        env:
          PWA_STRATEGY: none
        run: bash scripts/build_web.sh

